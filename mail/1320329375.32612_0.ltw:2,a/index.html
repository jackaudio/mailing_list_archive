<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Re: [Jack-Devel] RFC: jackd portnames</title>
<style>
pre {background: #fafafa; border: 1px solid #f1f2f3; font-size: 1.2em; padding: 10px; white-space: pre-wrap; white-space: -moz-pre-wrap; white-space: -pre-wrap; white-space: -o-pre-wrap; word-wrap: break-word;}
h1 {font-size: 140%;}
.header_table {table-layout: fixed; width: 100%;}
.col1 {width: 120px; vertical-align: top;}
.from {font-weight: bold;}
</style>
</head>
<body>
<h1>Re: [Jack-Devel] RFC: jackd portnames</h1>
<table class="header_table">
<tr><td class='col1'><a href='../1320325075.24387_0.ltw:2,a/index.html'>Prev</a></td><td><a href='../1320337733.16057_0.ltw:2,a/index.html'>Next</a>&nbsp;&nbsp;<a href='../../index.html#1320329375.32612_0.ltw:2,a'>Index</a></td></tr>
<tr><td class='col1'>Date</td><td>Thu, 03 Nov 2011 09:08:43 -0500 </td></tr>
<tr><td class='col1'>From</td><td><span class="from"> David Nielson </span> &lt;[hidden] at comcast dot net&gt; </td></tr>
<tr><td class='col1'>To</td><td>[hidden] at lists dot jackaudio dot org </td></tr>
<tr><td class='col1'>In-Reply-To</td><td>Adrian Knoth
<a href='../1320317666.13694_0.ltw:2,a/index.html'>[Jack-Devel] RFC: jackd portnames </a></td></tr>
</table>
<pre>
  ***APPLAUSE***

David Nielson
(Naptastic)

On 11/03/2011 05:53 AM, Adrian Knoth wrote:
&gt; Hi!
&gt;
&gt; I've forward-ported faberman's portname patch from jackd2-1.9.4 to
&gt; 1.9.7.
&gt;
&gt; It is supposed to provide stable port names across cards, no matter of
&gt; the underlying physical connection.
&gt;
&gt; I see mainly two use cases:
&gt;
&gt;     1.) Human-readable portnames on larger cards where "playback_56" is
&gt;         simply to cumbersome to figure out what's actually connected
&gt;
&gt;     2.) People who travel with ADAT-ADCs/DACs, but connect them via
&gt;         different interfaces in different locations, e.g. a Multiface
&gt;         when on the road and a RayDat when in the studio. Despite the
&gt;         different cards, the port names and hence any ardour session
&gt;         would remain intact.
&gt;
&gt; We would probably want a generic approach including firewire, either by
&gt; duplicating the code (bad) or somewhere higher in the higher layers, but
&gt; let's get started, first.
&gt;
&gt; Here is how it looks like:
&gt;
&gt;     http://adi.loris.tv/jackd2-portnames.png
&gt;
&gt; Right now, I've added a bit of verbosity to point the user to the
&gt; correct file location:
&gt;
&gt; Using port names patch v0.1 (07.04.2010)
&gt; Trying to load portnames from /home/racl/adi/.config/jack/cards/RME
&gt; RayDAT_f1cd85.ss.ports.in
&gt; Trying to load portnames from /home/racl/adi/.config/jack/cards/RME
&gt; RayDAT_f1cd85.ports.in
&gt; Trying to load portnames from /etc/jack/cards/RME RayDAT_f1cd85.ss.ports.in
&gt; Trying to load portnames from /etc/jack/cards/RME RayDAT_f1cd85.ports.in
&gt; Trying to load portnames from /home/racl/adi/.config/jack/cards/RME
&gt; RayDAT_f1cd85.ss.ports.out
&gt; Trying to load portnames from /home/racl/adi/.config/jack/cards/RME
&gt; RayDAT_f1cd85.ports.out
&gt; Trying to load portnames from /etc/jack/cards/RME RayDAT_f1cd85.ss.ports.out
&gt; Trying to load portnames from /etc/jack/cards/RME RayDAT_f1cd85.ports.out
&gt;
&gt;
&gt; The beginning of my ports.in file:
&gt;
&gt; # generated by hdspm
&gt; 1=Korg-L
&gt; 2=Korg-R
&gt; 3=IN-ADAT1.3
&gt; 4=IN-ADAT1.4
&gt; 5=IN-ADAT1.5
&gt; 6=IN-ADAT1.6
&gt; 7=Guitar
&gt; 8=Sindy
&gt;
&gt; While the generic portnames were defined by the driver, I had to prepend
&gt; an "IN-" to have different portnames for input and output.
&gt;
&gt; How do you feel about system:in:portname? This is easier for the user,
&gt; but a little less freedom.
&gt;
&gt; OTOH, I can also image cardname:portname in case users have multiple
&gt; cards.
&gt;
&gt; That's the main purpose of this RFC: what's a useful naming convention?
&gt; Any requirements from the pro-audio/broadcasting camp?
&gt;
&gt; Note that all the previous names are still available:
&gt;
&gt; $ jack_lsp -A
&gt; system:Korg-L
&gt;     alsa_pcm:hw:1,0:out1
&gt;     system:capture_1
&gt; system:Korg-R
&gt;     alsa_pcm:hw:1,0:out2
&gt;     system:capture_2
&gt; [...]
&gt;
&gt; This hopefully remains backward compatibility with existing sessions.
&gt;
&gt; Of course, if we agree on something, I'd forward-port faberman's jackd
&gt; version, too, but since jackd2 was installed on my workstation, I
&gt; started with jackd2.
&gt;
&gt;
&gt; Note that nobody has to use portnames. If the user does nothing, he'd
&gt; end up with his ordinary channel names. The patch hence targets more
&gt; advanced users.
&gt;
&gt;
&gt;
&gt; Cheers
&gt;
&gt; And here's the patch:
&gt;
&gt;
&gt; --- /dev/null
&gt; +++ b/linux/alsa/port_names.c
&gt; @@ -0,0 +1,179 @@
&gt; +/* -*- mode: c; c-file-style: "linux"; -*- */
&gt; +/*
&gt; +    Copyright (C) 2010 Florian Faber, [hidden]
&gt; +
&gt; +    This program is free software; you can redistribute it and/or modify
&gt; +    it under the terms of the GNU General Public License as published by
&gt; +    the Free Software Foundation; either version 2 of the License, or
&gt; +    (at your option) any later version.
&gt; +
&gt; +    This program is distributed in the hope that it will be useful,
&gt; +    but WITHOUT ANY WARRANTY; without even the implied warranty of
&gt; +    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
&gt; +    GNU General Public License for more details.
&gt; +
&gt; +    You should have received a copy of the GNU General Public License
&gt; +    along with this program; if not, write to the Free Software
&gt; +    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
&gt; +
&gt; +*/
&gt; +
&gt; +
&gt; +#include&lt;math.h&gt;
&gt; +#include&lt;stdio.h&gt;
&gt; +#include&lt;memory.h&gt;
&gt; +#include&lt;unistd.h&gt;
&gt; +#include&lt;stdlib.h&gt;
&gt; +#include&lt;errno.h&gt;
&gt; +#include&lt;stdarg.h&gt;
&gt; +#include&lt;signal.h&gt;
&gt; +#include&lt;sys/types.h&gt;
&gt; +#include&lt;regex.h&gt;
&gt; +#include&lt;string.h&gt;
&gt; +
&gt; +#include "alsa_driver.h"
&gt; +
&gt; +
&gt; +static int port_names_load_portfile(alsa_driver_t *driver, const char
&gt; *filename, char **buf, const unsigned int offset, const unsigned int num) {
&gt; +	int fh, i, ret, lineno, id, res=0;
&gt; +	char line[256];
&gt; +
&gt; +	printf("Trying to load portnames from %s\n", filename);
&gt; +	fh = open(filename, O_RDONLY);
&gt; +	if (-1!=fh) {
&gt; +		res = 1;
&gt; +		i = 0;
&gt; +		lineno = 1;
&gt; +		for (;;) {
&gt; +			ret = read(fh,&amp;line[i], 1);
&gt; +			if (0==ret) {
&gt; +				break;
&gt; +			} else if (-1==ret) {
&gt; +				sprintf(stderr, "Error while reading \"%s\": %s", filename,
&gt; strerror(errno));
&gt; +				break;
&gt; +			}
&gt; +			if (0x0A==line[i]) {
&gt; +				/* new line, parse input */
&gt; +				line[i] = 0;
&gt; +
&gt; +				if ('#' != line[0]) {
&gt; +					i=0;
&gt; +					while ((i&lt;255)&amp;&amp;  (line[i]!='=')) i++;
&gt; +					if (255==i) {
&gt; +						sprintf(stderr, "Error while reading \"%s\": Line %d has no
&gt; key=value syntax!", filename, lineno);
&gt; +					} else {
&gt; +						line[i] = 0;
&gt; +						id = atoi(line);
&gt; +						if ((id&gt;=1)&amp;&amp;  (id&lt;=num)) {
&gt; +							if (NULL==buf[id-1+offset]) {
&gt; +								/* don't overwrite existing names */
&gt; +								buf[id-1+offset] = strdup(&amp;line[i+1]);
&gt; +							}
&gt; +						} else {
&gt; +							sprintf(stderr, "Error while reading \"%s\": Key %d out of range
&gt; in line %d (1..%d)", filename, id, lineno, num);
&gt; +						}
&gt; +					}
&gt; +				}
&gt; +
&gt; +				i = 0;
&gt; +				lineno++;
&gt; +			} else {
&gt; +				i++;
&gt; +				if (i==255) {
&gt; +					sprintf(stderr, "Error while reading \"%s\": Line %d is too long",
&gt; filename, lineno);
&gt; +					break;
&gt; +				}
&gt; +			}
&gt; +		}
&gt; +
&gt; +		(void) close(fh);
&gt; +	}
&gt; +
&gt; +	return res;
&gt; +}
&gt; +
&gt; +
&gt; +static void port_names_default_portnames(char **buf, const unsigned int
&gt; offset, const unsigned int num, const char *defaultname) {
&gt; +	unsigned int i;
&gt; +	char line[256];
&gt; +
&gt; +	/* Fill in default names */
&gt; +	for (i=0; i&lt;num; i++) {
&gt; +		if (NULL==buf[i+offset]) {
&gt; +			snprintf(line, 255, defaultname, i+1);
&gt; +			buf[i+offset] = strdup(line);
&gt; +		}
&gt; +	}
&gt; +}
&gt; +
&gt; +
&gt; +char** port_names_get_portnames(alsa_driver_t *driver) {
&gt; +	snd_ctl_card_info_t *card_info;
&gt; +	int err;
&gt; +	const char *card_name = NULL;
&gt; +	char filename[256], *speed;
&gt; +	char **buf;
&gt; +
&gt; +	printf("Using port names patch v0.1 (07.04.2010)\n");
&gt; +
&gt; +	if (driver-&gt;frame_rate&gt;  96000) {
&gt; +		speed="qs";
&gt; +	} else if (driver-&gt;frame_rate&gt;  48000) {
&gt; +		speed="ds";
&gt; +	} else {
&gt; +		speed="ss";
&gt; +	}
&gt; +
&gt; +	snd_ctl_card_info_alloca(&amp;card_info);
&gt; +	err = snd_ctl_card_info(driver-&gt;ctl_handle, card_info);
&gt; +	if (err&gt;= 0) {
&gt; +		card_name = snd_ctl_card_info_get_name(card_info);
&gt; +	} else {
&gt; +		card_name = "noname";
&gt; +	}
&gt; +
&gt; +	buf = malloc(sizeof(char *)*(driver-&gt;capture_nchannels +
&gt; driver-&gt;playback_nchannels));
&gt; +	if (NULL==buf) {
&gt; +		sprintf(stderr, "ALSA: Not enough memory for %d port names",
&gt; driver-&gt;capture_nchannels + driver-&gt;playback_nchannels);
&gt; +		return NULL;
&gt; +	}
&gt; +	bzero(buf, sizeof(char *)*(driver-&gt;capture_nchannels +
&gt; driver-&gt;playback_nchannels));
&gt; +
&gt; +	/* Read port names from special to general:
&gt; +	 * Begin with user and speed specific port names */
&gt; +	snprintf(filename, 255, "%s/.config/jack/cards/%s.%s.ports.in",
&gt; getenv("HOME"), card_name, speed);
&gt; +	(void) port_names_load_portfile(driver, filename, buf, 0,
&gt; driver-&gt;capture_nchannels);
&gt; +
&gt; +	/* Now user general */
&gt; +	snprintf(filename, 255, "%s/.config/jack/cards/%s.ports.in",
&gt; getenv("HOME"), card_name);
&gt; +	(void) port_names_load_portfile(driver, filename, buf, 0,
&gt; driver-&gt;capture_nchannels);
&gt; +
&gt; +	/* System speed specific */
&gt; +	snprintf(filename, 255, "/etc/jack/cards/%s.%s.ports.in", card_name,
&gt; speed);
&gt; +	(void) port_names_load_portfile(driver, filename, buf, 0,
&gt; driver-&gt;capture_nchannels);
&gt; +
&gt; +	/* System general */
&gt; +	snprintf(filename, 255, "/etc/jack/cards/%s.ports.in", card_name);
&gt; +	(void) port_names_load_portfile(driver, filename, buf, 0,
&gt; driver-&gt;capture_nchannels);
&gt; +
&gt; +	/* Fill all still unnamed ports with default names */
&gt; +	port_names_default_portnames(buf, 0, driver-&gt;capture_nchannels,
&gt; "capture_%lu");
&gt; +
&gt; +
&gt; +	/* Same procedure for the playback channels */
&gt; +	snprintf(filename, 255, "%s/.config/jack/cards/%s.%s.ports.out",
&gt; getenv("HOME"), card_name, speed);
&gt; +	(void) port_names_load_portfile(driver, filename, buf,
&gt; driver-&gt;capture_nchannels, driver-&gt;playback_nchannels);
&gt; +
&gt; +	snprintf(filename, 255, "%s/.config/jack/cards/%s.ports.out",
&gt; getenv("HOME"), card_name);
&gt; +	(void) port_names_load_portfile(driver, filename, buf,
&gt; driver-&gt;capture_nchannels, driver-&gt;playback_nchannels);
&gt; +
&gt; +	snprintf(filename, 255, "/etc/jack/cards/%s.%s.ports.out", card_name,
&gt; speed);
&gt; +	(void) port_names_load_portfile(driver, filename, buf,
&gt; driver-&gt;capture_nchannels, driver-&gt;playback_nchannels);
&gt; +
&gt; +	snprintf(filename, 255, "/etc/jack/cards/%s.ports.out", card_name);
&gt; +	(void) port_names_load_portfile(driver, filename, buf,
&gt; driver-&gt;capture_nchannels, driver-&gt;playback_nchannels);
&gt; +
&gt; +	port_names_default_portnames(buf, driver-&gt;capture_nchannels,
&gt; driver-&gt;playback_nchannels, "playback_%lu");
&gt; +
&gt; +	return buf;
&gt; +}
&gt; --- /dev/null
&gt; +++ b/linux/alsa/port_names.h
&gt; @@ -0,0 +1,34 @@
&gt; +/*
&gt; +    Copyright (C) 2010 Florian Faber, [hidden]
&gt; +
&gt; +    This program is free software; you can redistribute it and/or modify
&gt; +    it under the terms of the GNU General Public License as published by
&gt; +    the Free Software Foundation; either version 2 of the License, or
&gt; +    (at your option) any later version.
&gt; +
&gt; +    This program is distributed in the hope that it will be useful,
&gt; +    but WITHOUT ANY WARRANTY; without even the implied warranty of
&gt; +    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
&gt; +    GNU General Public License for more details.
&gt; +
&gt; +    You should have received a copy of the GNU General Public License
&gt; +    along with this program; if not, write to the Free Software
&gt; +    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
&gt; +
&gt; +*/
&gt; +
&gt; +#ifndef __jack_port_names_h__
&gt; +#define __jack_port_names_h__
&gt; +
&gt; +#ifdef __cplusplus
&gt; +extern "C"
&gt; +{
&gt; +#endif
&gt; +
&gt; +char** port_names_get_portnames(alsa_driver_t *driver);
&gt; +
&gt; +#ifdef __cplusplus
&gt; +}
&gt; +#endif
&gt; +
&gt; +#endif /* __jack_port_names_h__ */
&gt; --- a/linux/alsa/JackAlsaDriver.cpp
&gt; +++ b/linux/alsa/JackAlsaDriver.cpp
&gt; @@ -43,6 +43,7 @@
&gt;   #include "JackPosixThread.h"
&gt;   #include "JackCompilerDeps.h"
&gt;   #include "JackServerGlobals.h"
&gt; +#include "port_names.h"
&gt;
&gt;   namespace Jack
&gt;   {
&gt; @@ -72,6 +73,8 @@
&gt;       unsigned long port_flags = (unsigned long)CaptureDriverFlags;
&gt;       char name[JACK_CLIENT_NAME_SIZE + JACK_PORT_NAME_SIZE];
&gt;       char alias[JACK_CLIENT_NAME_SIZE + JACK_PORT_NAME_SIZE];
&gt; +    char old_name[JACK_CLIENT_NAME_SIZE + JACK_PORT_NAME_SIZE];
&gt; +    char **portnames;
&gt;       jack_latency_range_t range;
&gt;
&gt;       assert(fCaptureChannels&lt;  DRIVER_PORT_NUM);
&gt; @@ -88,15 +91,20 @@
&gt;
&gt;       jack_log("JackAlsaDriver::Attach fBufferSize %ld fSampleRate %ld",
&gt; fEngineControl-&gt;fBufferSize, fEngineControl-&gt;fSampleRate);
&gt;
&gt; +    portnames = port_names_get_portnames(alsa_driver);
&gt; +
&gt;       for (int i = 0; i&lt;  fCaptureChannels; i++) {
&gt;           snprintf(alias, sizeof(alias) - 1, "%s:%s:out%d", fAliasName,
&gt; fCaptureDriverName, i + 1);
&gt; -        snprintf(name, sizeof(name) - 1, "%s:capture_%d",
&gt; fClientControl.fName, i + 1);
&gt; +        snprintf(old_name, sizeof(old_name) - 1, "%s:capture_%d",
&gt; fClientControl.fName, i + 1);
&gt; +        snprintf(name, sizeof(name) - 1, "%s:%s", fClientControl.fName,
&gt; portnames[i]);
&gt;           if ((port_index =
&gt; fGraphManager-&gt;AllocatePort(fClientControl.fRefNum, name,
&gt; JACK_DEFAULT_AUDIO_TYPE, (JackPortFlags)port_flags,
&gt; fEngineControl-&gt;fBufferSize)) == NO_PORT) {
&gt;               jack_error("driver: cannot register port for %s", name);
&gt;               return -1;
&gt;           }
&gt; +        free(portnames[i]);
&gt;           port = fGraphManager-&gt;GetPort(port_index);
&gt;           port-&gt;SetAlias(alias);
&gt; +        port-&gt;SetAlias(old_name);
&gt;           range.min = range.max = alsa_driver-&gt;frames_per_cycle +
&gt; alsa_driver-&gt;capture_frame_latency;
&gt;           port-&gt;SetLatencyRange(JackCaptureLatency,&amp;range);
&gt;           fCapturePortList[i] = port_index;
&gt; @@ -107,13 +115,16 @@
&gt;
&gt;       for (int i = 0; i&lt;  fPlaybackChannels; i++) {
&gt;           snprintf(alias, sizeof(alias) - 1, "%s:%s:in%d", fAliasName,
&gt; fPlaybackDriverName, i + 1);
&gt; -        snprintf(name, sizeof(name) - 1, "%s:playback_%d",
&gt; fClientControl.fName, i + 1);
&gt; +        snprintf(old_name, sizeof(old_name) - 1, "%s:playback_%d",
&gt; fClientControl.fName, i + 1);
&gt; +        snprintf(name, sizeof(name) - 1, "%s:%s", fClientControl.fName,
&gt; portnames[i+fCaptureChannels]);
&gt;           if ((port_index =
&gt; fGraphManager-&gt;AllocatePort(fClientControl.fRefNum, name,
&gt; JACK_DEFAULT_AUDIO_TYPE, (JackPortFlags)port_flags,
&gt; fEngineControl-&gt;fBufferSize)) == NO_PORT) {
&gt;               jack_error("driver: cannot register port for %s", name);
&gt;               return -1;
&gt;           }
&gt; +        free(portnames[i+fCaptureChannels]);
&gt;           port = fGraphManager-&gt;GetPort(port_index);
&gt;           port-&gt;SetAlias(alias);
&gt; +        port-&gt;SetAlias(old_name);
&gt;           // Add one buffer more latency if "async" mode is used...
&gt;           range.min = range.max = (alsa_driver-&gt;frames_per_cycle *
&gt; (alsa_driver-&gt;user_nperiods - 1)) +
&gt;                            ((fEngineControl-&gt;fSyncMode) ? 0 :
&gt; fEngineControl-&gt;fBufferSize) + alsa_driver-&gt;playback_frame_latency;
&gt; @@ -137,6 +148,8 @@
&gt;           }
&gt;       }
&gt;
&gt; +    free(portnames);
&gt; +
&gt;       if (alsa_driver-&gt;midi) {
&gt;           int err = (alsa_driver-&gt;midi-&gt;attach)(alsa_driver-&gt;midi);
&gt;           if (err)
&gt; --- a/linux/wscript
&gt; +++ b/linux/wscript
&gt; @@ -54,6 +54,7 @@
&gt;                          'alsa/hdsp.c',
&gt;   		       'alsa/alsa_driver.c',
&gt;                          'alsa/hammerfall.c',
&gt; +                       'alsa/port_names.c',
&gt;                          'alsa/ice1712.c'
&gt;                          ]
&gt;
&gt;
&gt;
&gt; 
&gt; Jack-Devel mailing list
&gt; [hidden]
&gt; http://lists.jackaudio.org/listinfo.cgi/jack-devel-jackaudio.org
</pre>
<table class="header_table">
<tr><td class='col1'><a href='../1320325075.24387_0.ltw:2,a/index.html'>Prev</a></td><td><a href='../1320337733.16057_0.ltw:2,a/index.html'>Next</a>&nbsp;&nbsp;<a href='../../index.html#1320329375.32612_0.ltw:2,a'>Index</a></td></tr>
</table>
<p><small>1320329375.32612_0.ltw:2,a&nbsp;&lt;4EB2A06B.4080900 at comcast dot net&gt;</small></p>
<!-- Created with Bash Archive Mail -->
</body>
</html>
